<template>
    <div class="cpe-container">
        <!-- LIVE PREVIEW SECTION -->
        <div class="preview-section">
            <div class="preview-header">
                <span class="preview-title">Preview</span>
                <lightning-button 
                    label="Refresh" 
                    icon-name="utility:refresh" 
                    variant="base"
                    onclick={refreshPreview}>
                </lightning-button>
            </div>
            <div class="preview-content" style={previewContainerStyle}>
                <template lwc:if={isLoadingPreview}>
                    <div class="preview-loading">
                        <lightning-spinner alternative-text="Loading preview" size="medium"></lightning-spinner>
                    </div>
                </template>
                <template lwc:elseif={previewError}>
                    <div class="preview-error">
                        <lightning-icon icon-name="utility:warning" variant="warning"></lightning-icon>
                        <span>{previewError}</span>
                    </div>
                </template>
                <template lwc:elseif={hasPreviewMarkers}>
                    <lightning-map
                        map-markers={previewMarkers}
                        zoom-level={zoomLevel}
                        list-view="hidden"
                        class="preview-map">
                    </lightning-map>
                </template>
                <template lwc:else>
                    <div class="preview-empty">
                        <lightning-icon icon-name="utility:location" size="large"></lightning-icon>
                        <span>Configure data source to see preview</span>
                    </div>
                </template>
            </div>
            <div class="preview-info">
                <template lwc:if={previewMarkerCount}>
                    <span class="marker-count">{previewMarkerCount} markers</span>
                </template>
            </div>
        </div>

        <!-- CONFIGURATION SECTIONS -->
        <div class="config-sections">
            
            <!-- SECTION 1: MAP TYPE -->
            <div class="cpe-section">
                <div class="section-header" data-section="mapType" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:world" size="small" class="section-icon"></lightning-icon>
                    <span class="section-title">Map Type</span>
                    <lightning-icon icon-name={mapTypeSectionIcon} size="x-small" class="chevron"></lightning-icon>
                </div>
                <div class={mapTypeSectionClass}>
                    <div class="map-type-selector">
                        <div class={googleMapClass} onclick={selectGoogleMaps} data-value="google">
                            <div class="map-type-icon">
                                <svg viewBox="0 0 24 24" width="48" height="48">
                                    <path fill="#4285F4" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                                    <circle fill="#fff" cx="12" cy="9" r="2.5"/>
                                </svg>
                            </div>
                            <div class="map-type-name">Google Maps</div>
                            <div class="map-type-desc">Familiar UI, Street View<br/>Max 100 markers</div>
                        </div>
                        <div class={leafletMapClass} onclick={selectLeafletMaps} data-value="leaflet">
                            <div class="map-type-icon">
                                <svg viewBox="0 0 24 24" width="48" height="48">
                                    <path fill="#3D9970" d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div class="map-type-name">Leaflet</div>
                            <div class="map-type-desc">Clustering, Drawing<br/>Unlimited markers</div>
                        </div>
                    </div>
                    
                    <lightning-input 
                        label="Map Height" 
                        value={height}
                        placeholder="400px"
                        onchange={handleHeightChange}>
                    </lightning-input>
                </div>
            </div>

            <!-- SECTION 2: DATA SOURCE -->
            <div class="cpe-section">
                <div class="section-header" data-section="dataSource" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:database" size="small" class="section-icon"></lightning-icon>
                    <span class="section-title">Data Source</span>
                    <lightning-icon icon-name={dataSourceSectionIcon} size="x-small" class="chevron"></lightning-icon>
                </div>
                <div class={dataSourceSectionClass}>
                    <lightning-button-group class="source-type-group">
                        <lightning-button 
                            label="Query" 
                            variant={queryButtonVariant}
                            onclick={handleSourceTypeChange} 
                            data-value="query">
                        </lightning-button>
                        <lightning-button 
                            label="Variable" 
                            variant={variableButtonVariant}
                            onclick={handleSourceTypeChange} 
                            data-value="variable">
                        </lightning-button>
                        <lightning-button 
                            label="Manual" 
                            variant={manualButtonVariant}
                            onclick={handleSourceTypeChange} 
                            data-value="manual">
                        </lightning-button>
                    </lightning-button-group>
                    
                    <!-- Query Mode: Object Selector -->
                    <template lwc:if={isQueryMode}>
                        <div class="field-group">
                            <lightning-combobox
                                label="Object"
                                value={objectApiName}
                                placeholder="Select an object..."
                                options={objectOptions}
                                onchange={handleObjectChange}
                                required>
                            </lightning-combobox>
                        </div>
                        
                        <div class="field-group">
                            <lightning-input 
                                label="Query Filter (WHERE clause)" 
                                value={queryFilter}
                                placeholder="Industry = 'Technology'"
                                field-level-help="Add conditions without the WHERE keyword"
                                onchange={handleQueryFilterChange}>
                            </lightning-input>
                        </div>
                        
                        <div class="field-group">
                            <lightning-input 
                                type="number" 
                                label="Record Limit" 
                                value={recordLimit}
                                min="1"
                                max="2000"
                                onchange={handleRecordLimitChange}>
                            </lightning-input>
                        </div>
                    </template>
                    
                    <!-- Variable/Manual Mode -->
                    <template lwc:if={isVariableOrManualMode}>
                        <div class="field-group">
                            <lightning-combobox
                                label="Markers Data"
                                value={markersJson}
                                placeholder="Select a variable..."
                                options={flowVariableOptions}
                                onchange={handleMarkersJsonChange}
                                field-level-help="Select a Flow variable containing marker data or enter JSON manually">
                            </lightning-combobox>
                            <template lwc:if={showManualJsonInput}>
                                <lightning-textarea 
                                    label="Markers JSON" 
                                    value={markersJson}
                                    placeholder="Enter JSON array of markers..."
                                    onchange={handleMarkersJsonChange}>
                                </lightning-textarea>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <!-- SECTION 3: FIELD MAPPINGS (Query Mode Only) -->
            <template lwc:if={isQueryMode}>
                <div class="cpe-section">
                    <div class="section-header" data-section="fieldMappings" onclick={toggleSection}>
                        <lightning-icon icon-name="utility:link" size="small" class="section-icon"></lightning-icon>
                        <span class="section-title">Data Mappings</span>
                        <lightning-icon icon-name={fieldMappingsSectionIcon} size="x-small" class="chevron"></lightning-icon>
                    </div>
                    <div class={fieldMappingsSectionClass}>
                        <!-- Title Field -->
                        <c-flow-map-field-picker
                            label="Title"
                            object-api-name={objectApiName}
                            value={titleField}
                            field-category="text"
                            help-text="Field to display as marker title"
                            onchange={handleTitleFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <!-- Description Field -->
                        <c-flow-map-field-picker
                            label="Description"
                            object-api-name={objectApiName}
                            value={descriptionField}
                            field-category="text"
                            help-text="Field to display in marker popup"
                            onchange={handleDescriptionFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <!-- Icon Field -->
                        <c-flow-map-field-picker
                            label="Icon Name"
                            object-api-name={objectApiName}
                            value={customIconField}
                            field-category="text"
                            help-text="Field containing SLDS icon name or SVG"
                            onchange={handleCustomIconFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <div class="subsection-title">Location</div>
                        
                        <div class="field-row">
                            <!-- Street Field -->
                            <c-flow-map-field-picker
                                label="Street"
                                object-api-name={objectApiName}
                                value={streetField}
                                field-category="address"
                                onchange={handleStreetFieldChange}>
                            </c-flow-map-field-picker>
                            
                            <!-- City Field -->
                            <c-flow-map-field-picker
                                label="City"
                                object-api-name={objectApiName}
                                value={cityField}
                                field-category="address"
                                onchange={handleCityFieldChange}>
                            </c-flow-map-field-picker>
                        </div>
                        
                        <div class="field-row">
                            <!-- State Field -->
                            <c-flow-map-field-picker
                                label="State"
                                object-api-name={objectApiName}
                                value={stateField}
                                field-category="address"
                                onchange={handleStateFieldChange}>
                            </c-flow-map-field-picker>
                            
                            <!-- Postal Code Field -->
                            <c-flow-map-field-picker
                                label="Postal Code"
                                object-api-name={objectApiName}
                                value={postalCodeField}
                                field-category="address"
                                onchange={handlePostalCodeFieldChange}>
                            </c-flow-map-field-picker>
                        </div>
                        
                        <!-- Country Field -->
                        <c-flow-map-field-picker
                            label="Country"
                            object-api-name={objectApiName}
                            value={countryField}
                            field-category="address"
                            onchange={handleCountryFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <template lwc:if={isLeafletMaps}>
                            <div class="subsection-title">
                                Coordinates
                                <span class="leaflet-badge">Leaflet</span>
                            </div>
                            
                            <div class="field-row">
                                <!-- Latitude Field -->
                                <c-flow-map-field-picker
                                    label="Latitude"
                                    object-api-name={objectApiName}
                                    value={latitudeField}
                                    field-category="location"
                                    onchange={handleLatitudeFieldChange}>
                                </c-flow-map-field-picker>
                                
                                <!-- Longitude Field -->
                                <c-flow-map-field-picker
                                    label="Longitude"
                                    object-api-name={objectApiName}
                                    value={longitudeField}
                                    field-category="location"
                                    onchange={handleLongitudeFieldChange}>
                                </c-flow-map-field-picker>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- SECTION 4: MAP CENTER -->
            <div class="cpe-section">
                <div class="section-header" data-section="mapCenter" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:target" size="small" class="section-icon"></lightning-icon>
                    <span class="section-title">Map Center</span>
                    <lightning-icon icon-name={mapCenterSectionIcon} size="x-small" class="chevron"></lightning-icon>
                </div>
                <div class={mapCenterSectionClass}>
                    <lightning-button-group class="center-type-group">
                        <lightning-button 
                            label="Coordinates" 
                            variant={coordinatesCenterVariant}
                            onclick={handleCenterTypeChange} 
                            data-value="coordinates">
                        </lightning-button>
                        <lightning-button 
                            label="Address" 
                            variant={addressCenterVariant}
                            onclick={handleCenterTypeChange} 
                            data-value="address">
                        </lightning-button>
                        <lightning-button 
                            label="Auto" 
                            variant={autoCenterVariant}
                            onclick={handleCenterTypeChange} 
                            data-value="auto">
                        </lightning-button>
                    </lightning-button-group>
                    
                    <template lwc:if={isCoordinatesCenter}>
                        <div class="field-row">
                            <lightning-input 
                                type="number" 
                                label="Latitude" 
                                value={centerLatitude}
                                step="0.0001"
                                placeholder="37.7749"
                                onchange={handleCenterLatitudeChange}>
                            </lightning-input>
                            <lightning-input 
                                type="number" 
                                label="Longitude" 
                                value={centerLongitude}
                                step="0.0001"
                                placeholder="-122.4194"
                                onchange={handleCenterLongitudeChange}>
                            </lightning-input>
                        </div>
                    </template>
                    
                    <template lwc:if={isAddressCenter}>
                        <lightning-input 
                            label="Street" 
                            value={centerStreet}
                            onchange={handleCenterStreetChange}>
                        </lightning-input>
                        <div class="field-row">
                            <lightning-input 
                                label="City" 
                                value={centerCity}
                                onchange={handleCenterCityChange}>
                            </lightning-input>
                            <lightning-input 
                                label="State" 
                                value={centerState}
                                onchange={handleCenterStateChange}>
                            </lightning-input>
                        </div>
                        <div class="field-row">
                            <lightning-input 
                                label="Postal Code" 
                                value={centerPostalCode}
                                onchange={handleCenterPostalCodeChange}>
                            </lightning-input>
                            <lightning-input 
                                label="Country" 
                                value={centerCountry}
                                onchange={handleCenterCountryChange}>
                            </lightning-input>
                        </div>
                    </template>
                    
                    <template lwc:if={isAutoCenter}>
                        <div class="info-box">
                            <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                            <span>Map will automatically center based on marker positions</span>
                        </div>
                    </template>
                    
                    <div class="zoom-control">
                        <lightning-slider 
                            label="Zoom Level" 
                            min="1" 
                            max="22" 
                            value={zoomLevel}
                            onchange={handleZoomLevelChange}>
                        </lightning-slider>
                        <div class="zoom-labels">
                            <span>World</span>
                            <span>City</span>
                            <span>Street</span>
                            <span>Building</span>
                        </div>
                        <div class="zoom-value">Level {zoomLevel}: {zoomLabel}</div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5: MARKER STYLE -->
            <div class="cpe-section">
                <div class="section-header" data-section="markerStyle" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:location" size="small" class="section-icon"></lightning-icon>
                    <span class="section-title">Marker Style</span>
                    <lightning-icon icon-name={markerStyleSectionIcon} size="x-small" class="chevron"></lightning-icon>
                </div>
                <div class={markerStyleSectionClass}>
                    <div class="subsection-title">Type</div>
                    <div class="marker-type-selector">
                        <div class={defaultMarkerClass} onclick={handleMarkerTypeChange} data-value="default">
                            <div class="marker-type-preview">
                                <svg viewBox="0 0 24 24" width="32" height="32">
                                    <path fill="#EA4335" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path>
                                </svg>
                            </div>
                            <div class="marker-type-name">Default</div>
                        </div>
                        <div class={circleMarkerClass} onclick={handleMarkerTypeChange} data-value="circle">
                            <div class="marker-type-preview">
                                <svg viewBox="0 0 24 24" width="32" height="32">
                                    <circle cx="12" cy="12" r="8" fill="#EA4335" stroke="#C62828" stroke-width="2"></circle>
                                </svg>
                            </div>
                            <div class="marker-type-name">Circle</div>
                        </div>
                        <div class={pinMarkerClass} onclick={handleMarkerTypeChange} data-value="pin">
                            <div class="marker-type-preview">
                                <svg viewBox="0 0 24 24" width="32" height="32">
                                    <path fill="#EA4335" stroke="#C62828" stroke-width="1" d="M12 2C8.69 2 6 4.69 6 8c0 5.5 6 14 6 14s6-8.5 6-14c0-3.31-2.69-6-6-6zm0 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"></path>
                                </svg>
                            </div>
                            <div class="marker-type-name">Pin</div>
                        </div>
                        <div class={customMarkerClass} onclick={handleMarkerTypeChange} data-value="customIcon">
                            <div class="marker-type-preview">
                                <svg viewBox="0 0 24 24" width="32" height="32">
                                    <rect x="4" y="4" width="16" height="16" fill="none" stroke="#EA4335" stroke-width="2" stroke-dasharray="4"></rect>
                                    <text x="12" y="16" text-anchor="middle" font-size="10" fill="#EA4335">SVG</text>
                                </svg>
                            </div>
                            <div class="marker-type-name">Custom</div>
                        </div>
                    </div>

                    <div class="subsection-title">Colors</div>
                    <div class="color-row">
                        <div class="color-input">
                            <label>Fill Color</label>
                            <div class="color-picker-wrapper">
                                <input type="color" value={markerFillColor} onchange={handleMarkerFillColorChange}/>
                                <lightning-input 
                                    value={markerFillColor}
                                    onchange={handleMarkerFillColorChange}
                                    class="color-text">
                                </lightning-input>
                            </div>
                        </div>
                        <div class="color-input">
                            <label>Stroke Color</label>
                            <div class="color-picker-wrapper">
                                <input type="color" value={markerStrokeColor} onchange={handleMarkerStrokeColorChange}/>
                                <lightning-input 
                                    value={markerStrokeColor}
                                    onchange={handleMarkerStrokeColorChange}
                                    class="color-text">
                                </lightning-input>
                            </div>
                        </div>
                    </div>
                    
                    <template lwc:if={isCustomMarkerType}>
                        <lightning-textarea 
                            label="Custom Icon SVG" 
                            value={customIconSvg}
                            placeholder="Enter SVG markup"
                            onchange={handleCustomIconSvgChange}>
                        </lightning-textarea>
                    </template>
                </div>
            </div>

            <!-- SECTION 6: CLUSTERING (Leaflet Only) -->
            <template lwc:if={isLeafletMaps}>
                <div class="cpe-section">
                    <div class="section-header" data-section="clustering" onclick={toggleSection}>
                        <lightning-icon icon-name="utility:groups" size="small" class="section-icon"></lightning-icon>
                        <span class="section-title">Clustering</span>
                        <span class="leaflet-badge">Leaflet</span>
                        <lightning-icon icon-name={clusteringSectionIcon} size="x-small" class="chevron"></lightning-icon>
                    </div>
                    <div class={clusteringSectionClass}>
                        <lightning-input 
                            type="toggle" 
                            label="Enable Clustering" 
                            checked={enableClustering}
                            onchange={handleEnableClusteringChange}>
                        </lightning-input>
                        
                        <template lwc:if={enableClustering}>
                            <lightning-input 
                                type="toggle" 
                                label="Show Coverage on Hover" 
                                checked={showCoverageOnHover}
                                onchange={handleShowCoverageOnHoverChange}>
                            </lightning-input>
                            
                            <lightning-input 
                                type="number" 
                                label="Max Cluster Radius (px)" 
                                value={maxClusterRadius}
                                min="10"
                                max="200"
                                onchange={handleMaxClusterRadiusChange}>
                            </lightning-input>
                        </template>
                    </div>
                </div>
            </template>

            <!-- SECTION 7: DRAWING (Leaflet Only) -->
            <template lwc:if={isLeafletMaps}>
                <div class="cpe-section">
                    <div class="section-header" data-section="drawing" onclick={toggleSection}>
                        <lightning-icon icon-name="utility:edit" size="small" class="section-icon"></lightning-icon>
                        <span class="section-title">Drawing Tools</span>
                        <span class="leaflet-badge">Leaflet</span>
                        <lightning-icon icon-name={drawingSectionIcon} size="x-small" class="chevron"></lightning-icon>
                    </div>
                    <div class={drawingSectionClass}>
                        <lightning-input 
                            type="toggle" 
                            label="Enable Drawing" 
                            checked={enableDrawing}
                            onchange={handleEnableDrawingChange}>
                        </lightning-input>
                        
                        <template lwc:if={enableDrawing}>
                            <div class="subsection-title">Available Tools</div>
                            <div class="drawing-tools-grid">
                                <lightning-input type="checkbox" label="Marker" checked={drawToolMarker} onchange={handleDrawToolMarkerChange}></lightning-input>
                                <lightning-input type="checkbox" label="Line" checked={drawToolLine} onchange={handleDrawToolLineChange}></lightning-input>
                                <lightning-input type="checkbox" label="Polygon" checked={drawToolPolygon} onchange={handleDrawToolPolygonChange}></lightning-input>
                                <lightning-input type="checkbox" label="Circle" checked={drawToolCircle} onchange={handleDrawToolCircleChange}></lightning-input>
                                <lightning-input type="checkbox" label="Edit" checked={drawToolEdit} onchange={handleDrawToolEditChange}></lightning-input>
                                <lightning-input type="checkbox" label="Delete" checked={drawToolDelete} onchange={handleDrawToolDeleteChange}></lightning-input>
                            </div>
                            
                            <lightning-combobox
                                label="Toolbar Position"
                                value={drawToolbarPosition}
                                options={toolbarPositionOptions}
                                onchange={handleDrawToolbarPositionChange}>
                            </lightning-combobox>
                        </template>
                    </div>
                </div>
            </template>

            <!-- SECTION 8: HEADER & UI -->
            <div class="cpe-section">
                <div class="section-header" data-section="headerUI" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:layout" size="small" class="section-icon"></lightning-icon>
                    <span class="section-title">Header &amp; UI</span>
                    <lightning-icon icon-name={headerUISectionIcon} size="x-small" class="chevron"></lightning-icon>
                </div>
                <div class={headerUISectionClass}>
                    <lightning-input 
                        label="Title" 
                        value={title}
                        placeholder="Map Title"
                        onchange={handleTitleChange}>
                    </lightning-input>
                    
                    <lightning-input 
                        label="Caption" 
                        value={caption}
                        placeholder="Optional subtitle"
                        onchange={handleCaptionChange}>
                    </lightning-input>
                    
                    <lightning-input 
                        label="Icon Name" 
                        value={iconName}
                        placeholder="utility:location"
                        field-level-help="SLDS icon name (e.g., utility:location)"
                        onchange={handleIconNameChange}>
                    </lightning-input>
                    
                    <lightning-input 
                        type="checkbox" 
                        label="Joined Header Style" 
                        checked={isJoined}
                        onchange={handleIsJoinedChange}>
                    </lightning-input>
                </div>
            </div>

            <!-- SECTION 9: LIST & SEARCH -->
            <div class="cpe-section">
                <div class="section-header" data-section="listSearch" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:side_list" size="small" class="section-icon"></lightning-icon>
                    <span class="section-title">List Panel</span>
                    <lightning-icon icon-name={listSearchSectionIcon} size="x-small" class="chevron"></lightning-icon>
                </div>
                <div class={listSearchSectionClass}>
                    <lightning-combobox
                        label="List Visibility"
                        value={listViewVisibility}
                        options={listViewOptions}
                        onchange={handleListViewVisibilityChange}>
                    </lightning-combobox>
                    
                    <div class="field-row">
                        <lightning-combobox
                            label="List Position"
                            value={listPosition}
                            options={listPositionOptions}
                            onchange={handleListPositionChange}>
                        </lightning-combobox>
                    </div>
                    
                    <lightning-input 
                        type="toggle" 
                        label="Allow Collapse/Expand" 
                        checked={listCollapsible}
                        field-level-help="Let users collapse and expand the list panel"
                        onchange={handleListCollapsibleChange}>
                    </lightning-input>
                    
                    <div class="subsection-title">Search</div>
                    
                    <lightning-input 
                        type="toggle" 
                        label="Enable Search" 
                        checked={isSearchable}
                        onchange={handleIsSearchableChange}>
                    </lightning-input>
                    
                    <template lwc:if={isSearchable}>
                        <lightning-input 
                            label="Search Placeholder" 
                            value={searchPlaceholder}
                            onchange={handleSearchPlaceholderChange}>
                        </lightning-input>
                        
                        <lightning-combobox
                            label="Search Position"
                            value={searchPosition}
                            options={searchPositionOptions}
                            onchange={handleSearchPositionChange}>
                        </lightning-combobox>
                    </template>
                    
                    <lightning-input 
                        type="toggle" 
                        label="Enable Marker Drag" 
                        checked={enableMarkerDrag}
                        onchange={handleEnableMarkerDragChange}>
                    </lightning-input>
                </div>
            </div>
            
            <!-- SECTION: POPUP CUSTOMIZATION -->
            <template lwc:if={isQueryMode}>
                <div class="cpe-section">
                    <div class="section-header" data-section="popupCustomization" onclick={toggleSection}>
                        <lightning-icon icon-name="utility:info" size="small" class="section-icon"></lightning-icon>
                        <span class="section-title">Marker Popup</span>
                        <lightning-icon icon-name={popupCustomizationSectionIcon} size="x-small" class="chevron"></lightning-icon>
                    </div>
                    <div class={popupCustomizationSectionClass}>
                        <div class="info-box">
                            <lightning-icon icon-name="utility:info" size="x-small"></lightning-icon>
                            <span>Customize what appears when clicking a marker. Leave blank to use default Title/Description fields.</span>
                        </div>
                        
                        <c-flow-map-field-picker
                            label="Popup Title"
                            object-api-name={objectApiName}
                            value={popupTitleField}
                            field-category="text"
                            help-text="Field to show as popup header"
                            onchange={handlePopupTitleFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <c-flow-map-field-picker
                            label="Popup Description"
                            object-api-name={objectApiName}
                            value={popupDescriptionField}
                            field-category="text"
                            help-text="Field to show as popup body text"
                            onchange={handlePopupDescriptionFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <c-flow-map-field-picker
                            label="Popup Address"
                            object-api-name={objectApiName}
                            value={popupAddressField}
                            field-category="address"
                            help-text="Address field to show in popup"
                            onchange={handlePopupAddressFieldChange}>
                        </c-flow-map-field-picker>
                        
                        <lightning-textarea 
                            label="Custom Fields (JSON)" 
                            value={popupCustomFieldsJson}
                            placeholder="See help text for format"
                            field-level-help="JSON array of additional fields to display"
                            onchange={handlePopupCustomFieldsJsonChange}>
                        </lightning-textarea>
                        
                        <lightning-input 
                            type="toggle" 
                            label="Show Navigate Button" 
                            checked={popupShowNavigateButton}
                            field-level-help="Show a button to open directions in Google Maps"
                            onchange={handlePopupShowNavigateButtonChange}>
                        </lightning-input>
                    </div>
                </div>
            </template>

        </div>
    </div>
</template>

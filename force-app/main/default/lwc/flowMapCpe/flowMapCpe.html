<template>
    <div class="cpe-container">
        <!-- ============================================ -->
        <!-- MAP TYPE SECTION -->
        <!-- ============================================ -->
        <div class="slds-card slds-m-bottom_small">
            <div class="section-header" data-section="mapType" onclick={toggleSection}>
                <lightning-icon icon-name="utility:world" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                <span class="section-title">Map Type</span>
                <lightning-icon icon-name={mapTypeChevron} size="x-small" class="chevron-icon"></lightning-icon>
            </div>
            <template if:true={mapTypeExpanded}>
                <div class="section-content">
                    <lightning-radio-group
                        name="mapType"
                        label="Select Map Provider"
                        options={mapTypeOptions}
                        value={mapType}
                        type="button"
                        onchange={handleMapTypeChange}>
                    </lightning-radio-group>
                    <div class="slds-m-top_x-small">
                        <template if:true={isGoogleMaps}>
                            <span class="slds-text-color_weak slds-text-body_small">
                                Google Maps: Easy address geocoding, max 100 markers
                            </span>
                        </template>
                        <template if:true={isLeaflet}>
                            <span class="slds-text-color_weak slds-text-body_small">
                                Leaflet: Unlimited markers, clustering, drawing tools (requires coordinates)
                            </span>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <!-- ============================================ -->
        <!-- DATA SOURCE SECTION -->
        <!-- ============================================ -->
        <div class="slds-card slds-m-bottom_small">
            <div class="section-header" data-section="dataSource" onclick={toggleSection}>
                <lightning-icon icon-name="utility:database" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                <span class="section-title">Data Source</span>
                <lightning-icon icon-name={dataSourceChevron} size="x-small" class="chevron-icon"></lightning-icon>
            </div>
            <template if:true={dataSourceExpanded}>
                <div class="section-content">
                    <lightning-combobox
                        name="sourceType"
                        label="Data Source Type"
                        value={sourceType}
                        options={sourceTypeOptions}
                        onchange={handleSourceTypeChange}>
                    </lightning-combobox>

                    <template if:true={isQuerySource}>
                        <lightning-combobox
                            name="objectApiName"
                            label="Object"
                            placeholder="Select an object..."
                            value={objectApiName}
                            options={objectOptions}
                            onchange={handleObjectChange}
                            disabled={isLoadingObjects}
                            class="slds-m-top_small">
                        </lightning-combobox>

                        <lightning-input
                            type="text"
                            label="Query Filter (WHERE clause)"
                            value={queryFilter}
                            placeholder="e.g., BillingCity != null"
                            onchange={handleQueryFilterChange}
                            class="slds-m-top_small">
                        </lightning-input>

                        <lightning-input
                            type="number"
                            label="Record Limit"
                            value={recordLimit}
                            min="1"
                            max="2000"
                            onchange={handleRecordLimitChange}
                            class="slds-m-top_small">
                        </lightning-input>
                    </template>

                    <template if:true={isManualSource}>
                        <lightning-textarea
                            label="Markers JSON"
                            value={markersJson}
                            placeholder='[{"title":"Location","latitude":37.7749,"longitude":-122.4194}]'
                            onchange={handleMarkersJsonChange}
                            class="slds-m-top_small">
                        </lightning-textarea>
                    </template>
                </div>
            </template>
        </div>

        <!-- ============================================ -->
        <!-- FIELD MAPPINGS SECTION -->
        <!-- ============================================ -->
        <template if:true={isQuerySource}>
            <div class="slds-card slds-m-bottom_small">
                <div class="section-header" data-section="fieldMappings" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:text" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    <span class="section-title">Field Mappings</span>
                    <lightning-icon icon-name={fieldMappingsChevron} size="x-small" class="chevron-icon"></lightning-icon>
                </div>
                <template if:true={fieldMappingsExpanded}>
                    <div class="section-content">
                        <!-- Title & Description -->
                        <div class="field-group">
                            <p class="field-group-title">Display Fields</p>
                            <lightning-combobox
                                name="titleField"
                                label="Title Field"
                                placeholder="Select field..."
                                value={titleField}
                                options={fieldOptions}
                                onchange={handleTitleFieldChange}
                                disabled={isLoadingFields}>
                            </lightning-combobox>
                            <lightning-combobox
                                name="descriptionField"
                                label="Description Field"
                                placeholder="Select field..."
                                value={descriptionField}
                                options={fieldOptions}
                                onchange={handleDescriptionFieldChange}
                                disabled={isLoadingFields}
                                class="slds-m-top_x-small">
                            </lightning-combobox>
                        </div>

                        <!-- Location Fields -->
                        <div class="field-group slds-m-top_small">
                            <p class="field-group-title">Location Fields</p>
                            <template if:true={isLeaflet}>
                                <div class="slds-grid slds-gutters_x-small">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox
                                            name="latitudeField"
                                            label="Latitude Field"
                                            placeholder="Select field..."
                                            value={latitudeField}
                                            options={fieldOptions}
                                            onchange={handleLatitudeFieldChange}
                                            disabled={isLoadingFields}>
                                        </lightning-combobox>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox
                                            name="longitudeField"
                                            label="Longitude Field"
                                            placeholder="Select field..."
                                            value={longitudeField}
                                            options={fieldOptions}
                                            onchange={handleLongitudeFieldChange}
                                            disabled={isLoadingFields}>
                                        </lightning-combobox>
                                    </div>
                                </div>
                            </template>

                            <template if:true={isGoogleMaps}>
                                <lightning-combobox
                                    name="streetField"
                                    label="Street Field"
                                    placeholder="Select field..."
                                    value={streetField}
                                    options={fieldOptions}
                                    onchange={handleStreetFieldChange}
                                    disabled={isLoadingFields}>
                                </lightning-combobox>
                                <div class="slds-grid slds-gutters_x-small slds-m-top_x-small">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox
                                            name="cityField"
                                            label="City Field"
                                            placeholder="Select field..."
                                            value={cityField}
                                            options={fieldOptions}
                                            onchange={handleCityFieldChange}
                                            disabled={isLoadingFields}>
                                        </lightning-combobox>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox
                                            name="stateField"
                                            label="State Field"
                                            placeholder="Select field..."
                                            value={stateField}
                                            options={fieldOptions}
                                            onchange={handleStateFieldChange}
                                            disabled={isLoadingFields}>
                                        </lightning-combobox>
                                    </div>
                                </div>
                                <div class="slds-grid slds-gutters_x-small slds-m-top_x-small">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox
                                            name="postalCodeField"
                                            label="Postal Code Field"
                                            placeholder="Select field..."
                                            value={postalCodeField}
                                            options={fieldOptions}
                                            onchange={handlePostalCodeFieldChange}
                                            disabled={isLoadingFields}>
                                        </lightning-combobox>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-combobox
                                            name="countryField"
                                            label="Country Field"
                                            placeholder="Select field..."
                                            value={countryField}
                                            options={fieldOptions}
                                            onchange={handleCountryFieldChange}
                                            disabled={isLoadingFields}>
                                        </lightning-combobox>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- ============================================ -->
        <!-- MAP CENTER SECTION -->
        <!-- ============================================ -->
        <div class="slds-card slds-m-bottom_small">
            <div class="section-header" data-section="mapCenter" onclick={toggleSection}>
                <lightning-icon icon-name="utility:location" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                <span class="section-title">Map Center</span>
                <lightning-icon icon-name={mapCenterChevron} size="x-small" class="chevron-icon"></lightning-icon>
            </div>
            <template if:true={mapCenterExpanded}>
                <div class="section-content">
                    <lightning-combobox
                        name="centerType"
                        label="Center Type"
                        value={centerType}
                        options={centerTypeOptions}
                        onchange={handleCenterTypeChange}>
                    </lightning-combobox>

                    <template if:true={showCoordinateCenter}>
                        <div class="slds-grid slds-gutters_x-small slds-m-top_small">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="text"
                                    label="Latitude"
                                    value={centerLatitude}
                                    placeholder="e.g., 37.7749"
                                    onchange={handleCenterLatitudeChange}>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="text"
                                    label="Longitude"
                                    value={centerLongitude}
                                    placeholder="e.g., -122.4194"
                                    onchange={handleCenterLongitudeChange}>
                                </lightning-input>
                            </div>
                        </div>
                    </template>

                    <template if:true={showAddressCenter}>
                        <lightning-input
                            type="text"
                            label="Street"
                            value={centerStreet}
                            onchange={handleCenterStreetChange}
                            class="slds-m-top_small">
                        </lightning-input>
                        <div class="slds-grid slds-gutters_x-small slds-m-top_x-small">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="text"
                                    label="City"
                                    value={centerCity}
                                    onchange={handleCenterCityChange}>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="text"
                                    label="State/Province"
                                    value={centerState}
                                    onchange={handleCenterStateChange}>
                                </lightning-input>
                            </div>
                        </div>
                        <div class="slds-grid slds-gutters_x-small slds-m-top_x-small">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="text"
                                    label="Postal Code"
                                    value={centerPostalCode}
                                    onchange={handleCenterPostalCodeChange}>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="text"
                                    label="Country"
                                    value={centerCountry}
                                    onchange={handleCenterCountryChange}>
                                </lightning-input>
                            </div>
                        </div>
                    </template>

                    <lightning-slider
                        label="Zoom Level"
                        value={zoomLevel}
                        min="1"
                        max="22"
                        step="1"
                        onchange={handleZoomLevelChange}
                        class="slds-m-top_small">
                    </lightning-slider>

                    <lightning-input
                        type="checkbox"
                        label="Display Center as Marker"
                        checked={displayCenterAsMarker}
                        onchange={handleDisplayCenterAsMarkerChange}
                        class="slds-m-top_small">
                    </lightning-input>
                </div>
            </template>
        </div>

        <!-- ============================================ -->
        <!-- MARKER STYLE SECTION -->
        <!-- ============================================ -->
        <div class="slds-card slds-m-bottom_small">
            <div class="section-header" data-section="markerStyle" onclick={toggleSection}>
                <lightning-icon icon-name="utility:pin" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                <span class="section-title">Marker Style</span>
                <lightning-icon icon-name={markerStyleChevron} size="x-small" class="chevron-icon"></lightning-icon>
            </div>
            <template if:true={markerStyleExpanded}>
                <div class="section-content">
                    <lightning-combobox
                        name="markerType"
                        label="Marker Type"
                        value={markerType}
                        options={markerTypeOptions}
                        onchange={handleMarkerTypeChange}>
                    </lightning-combobox>

                    <template if:true={showMarkerColorOptions}>
                        <div class="slds-grid slds-gutters_x-small slds-m-top_small">
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="color"
                                    label="Fill Color"
                                    value={markerFillColor}
                                    onchange={handleMarkerFillColorChange}>
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-2">
                                <lightning-input
                                    type="color"
                                    label="Stroke Color"
                                    value={markerStrokeColor}
                                    onchange={handleMarkerStrokeColorChange}>
                                </lightning-input>
                            </div>
                        </div>

                        <lightning-input
                            type="number"
                            label="Marker Radius"
                            value={markerRadius}
                            min="5"
                            max="50"
                            onchange={handleMarkerRadiusChange}
                            class="slds-m-top_small">
                        </lightning-input>
                    </template>

                    <template if:true={showCustomIconOptions}>
                        <lightning-textarea
                            label="Custom Icon SVG"
                            value={customIconSvg}
                            placeholder="<svg>...</svg>"
                            onchange={handleCustomIconSvgChange}
                            class="slds-m-top_small">
                        </lightning-textarea>
                    </template>
                </div>
            </template>
        </div>

        <!-- ============================================ -->
        <!-- CLUSTERING SECTION (LEAFLET ONLY) -->
        <!-- ============================================ -->
        <template if:true={isLeaflet}>
            <div class="slds-card slds-m-bottom_small">
                <div class="section-header" data-section="clustering" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:groups" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    <span class="section-title">Clustering</span>
                    <lightning-icon icon-name={clusteringChevron} size="x-small" class="chevron-icon"></lightning-icon>
                </div>
                <template if:true={clusteringExpanded}>
                    <div class="section-content">
                        <lightning-input
                            type="checkbox"
                            label="Enable Marker Clustering"
                            checked={enableClustering}
                            onchange={handleEnableClusteringChange}>
                        </lightning-input>

                        <template if:true={enableClustering}>
                            <lightning-input
                                type="checkbox"
                                label="Show Coverage on Hover"
                                checked={showCoverageOnHover}
                                onchange={handleShowCoverageOnHoverChange}
                                class="slds-m-top_small">
                            </lightning-input>

                            <lightning-input
                                type="number"
                                label="Max Cluster Radius"
                                value={maxClusterRadius}
                                min="10"
                                max="200"
                                onchange={handleMaxClusterRadiusChange}
                                class="slds-m-top_small">
                            </lightning-input>

                            <lightning-input
                                type="number"
                                label="Disable Clustering at Zoom"
                                value={disableClusteringAtZoom}
                                min="1"
                                max="22"
                                placeholder="Leave empty for default"
                                onchange={handleDisableClusteringAtZoomChange}
                                class="slds-m-top_small">
                            </lightning-input>
                        </template>
                    </div>
                </template>
            </div>

            <!-- ============================================ -->
            <!-- DRAWING TOOLS SECTION (LEAFLET ONLY) -->
            <!-- ============================================ -->
            <div class="slds-card slds-m-bottom_small">
                <div class="section-header" data-section="drawing" onclick={toggleSection}>
                    <lightning-icon icon-name="utility:edit" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    <span class="section-title">Drawing Tools</span>
                    <lightning-icon icon-name={drawingChevron} size="x-small" class="chevron-icon"></lightning-icon>
                </div>
                <template if:true={drawingExpanded}>
                    <div class="section-content">
                        <lightning-input
                            type="checkbox"
                            label="Enable Drawing"
                            checked={enableDrawing}
                            onchange={handleEnableDrawingChange}>
                        </lightning-input>

                        <template if:true={enableDrawing}>
                            <div class="slds-m-top_small">
                                <p class="field-group-title">Available Tools</p>
                                <div class="slds-grid slds-wrap slds-gutters_x-small">
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input
                                            type="checkbox"
                                            label="Marker"
                                            checked={drawToolMarker}
                                            onchange={handleDrawToolMarkerChange}>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input
                                            type="checkbox"
                                            label="Line"
                                            checked={drawToolLine}
                                            onchange={handleDrawToolLineChange}>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input
                                            type="checkbox"
                                            label="Polygon"
                                            checked={drawToolPolygon}
                                            onchange={handleDrawToolPolygonChange}>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input
                                            type="checkbox"
                                            label="Circle"
                                            checked={drawToolCircle}
                                            onchange={handleDrawToolCircleChange}>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input
                                            type="checkbox"
                                            label="Edit"
                                            checked={drawToolEdit}
                                            onchange={handleDrawToolEditChange}>
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-2">
                                        <lightning-input
                                            type="checkbox"
                                            label="Delete"
                                            checked={drawToolDelete}
                                            onchange={handleDrawToolDeleteChange}>
                                        </lightning-input>
                                    </div>
                                </div>
                            </div>

                            <lightning-combobox
                                name="drawToolbarPosition"
                                label="Toolbar Position"
                                value={drawToolbarPosition}
                                options={toolbarPositionOptions}
                                onchange={handleDrawToolbarPositionChange}
                                class="slds-m-top_small">
                            </lightning-combobox>
                        </template>
                    </div>
                </template>
            </div>
        </template>

        <!-- ============================================ -->
        <!-- LIST & SEARCH SECTION -->
        <!-- ============================================ -->
        <div class="slds-card slds-m-bottom_small">
            <div class="section-header" data-section="listSearch" onclick={toggleSection}>
                <lightning-icon icon-name="utility:list" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                <span class="section-title">List and Search</span>
                <lightning-icon icon-name={listSearchChevron} size="x-small" class="chevron-icon"></lightning-icon>
            </div>
            <template if:true={listSearchExpanded}>
                <div class="section-content">
                    <lightning-combobox
                        name="listViewVisibility"
                        label="List View"
                        value={listViewVisibility}
                        options={listViewOptions}
                        onchange={handleListViewVisibilityChange}>
                    </lightning-combobox>

                    <lightning-combobox
                        name="listPosition"
                        label="List Position"
                        value={listPosition}
                        options={listPositionOptions}
                        onchange={handleListPositionChange}
                        class="slds-m-top_small">
                    </lightning-combobox>

                    <lightning-input
                        type="checkbox"
                        label="List Collapsible"
                        checked={listCollapsible}
                        onchange={handleListCollapsibleChange}
                        class="slds-m-top_small">
                    </lightning-input>

                    <div class="slds-m-top_medium">
                        <lightning-input
                            type="checkbox"
                            label="Enable Search"
                            checked={isSearchable}
                            onchange={handleIsSearchableChange}>
                        </lightning-input>

                        <template if:true={isSearchable}>
                            <lightning-input
                                type="text"
                                label="Search Placeholder"
                                value={searchPlaceholder}
                                onchange={handleSearchPlaceholderChange}
                                class="slds-m-top_small">
                            </lightning-input>

                            <lightning-combobox
                                name="searchPosition"
                                label="Search Position"
                                value={searchPosition}
                                options={searchPositionOptions}
                                onchange={handleSearchPositionChange}
                                class="slds-m-top_small">
                            </lightning-combobox>
                        </template>
                    </div>

                    <template if:true={isLeaflet}>
                        <lightning-input
                            type="checkbox"
                            label="Enable Marker Drag"
                            checked={enableMarkerDrag}
                            onchange={handleEnableMarkerDragChange}
                            class="slds-m-top_medium">
                        </lightning-input>
                    </template>
                </div>
            </template>
        </div>

        <!-- ============================================ -->
        <!-- BASIC CONFIGURATION SECTION -->
        <!-- ============================================ -->
        <div class="slds-card slds-m-bottom_small">
            <div class="section-header" data-section="basic" onclick={toggleSection}>
                <lightning-icon icon-name="utility:settings" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                <span class="section-title">Header and Display</span>
                <lightning-icon icon-name={basicChevron} size="x-small" class="chevron-icon"></lightning-icon>
            </div>
            <template if:true={basicExpanded}>
                <div class="section-content">
                    <lightning-input
                        type="text"
                        label="Title"
                        value={title}
                        placeholder="Map Title"
                        onchange={handleTitleChange}>
                    </lightning-input>

                    <lightning-input
                        type="text"
                        label="Caption"
                        value={caption}
                        placeholder="Optional subtitle"
                        onchange={handleCaptionChange}
                        class="slds-m-top_small">
                    </lightning-input>

                    <lightning-input
                        type="text"
                        label="Icon Name"
                        value={iconName}
                        placeholder="e.g., utility:location"
                        onchange={handleIconNameChange}
                        class="slds-m-top_small">
                    </lightning-input>

                    <lightning-input
                        type="text"
                        label="Map Height"
                        value={height}
                        placeholder="e.g., 400px or 50vh"
                        onchange={handleHeightChange}
                        class="slds-m-top_small">
                    </lightning-input>
                </div>
            </template>
        </div>
    </div>
</template>
